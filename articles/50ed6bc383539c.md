---
title: "Rails on ECS with FluentBitな構成で快適なログ分析環境を構築する"
emoji: "✨"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Rails", "AWS"]
published: false
---
## この記事は？？

Rails on ECSな構成で運用する時、通常Dokcerのログドライバに `awslogs` を指定してログを

CloudWatch Logsに配信すると思います。ただしこのやり方には問題があり、複数行のログが

ログストリームに１行ずつログイベントして蓄積されていくことです。

例えばRailsの開発をしているときは以下の様なログを確認しながら開発を進めていくと思いますが、

これらが1行ずつログストリームに配信されます。これでは不具合が発生した時に発生した場所や

不具合の内容を特定するのが困難になります。

この記事ではまずログをjson構造で配信することにより解消します。なぜJSONで配信するかというと

CloudWatch Logsには `{ $.user_id = 12 }` の様にJSONのキーを指定して検索することが出来るため、上記のように特定のユーザーのログを抽出することが可能になります。

またCloudWatchにはアプリケーションのログ以外にヘルスチェックのログも配信されます。

ただヘルスチェックのログはチェック間隔にもよりますが、かなりの量になると思います。

ログを閲覧する際にヘルスチェックのログは不要だと思うのでFluentBitでログルーティングを実施し

別のログストリームに配信する方法を紹介します。

## この記事のゴール

1. RailsのログをJSON形式に構造化して、CloudWatch Logsに配信する
2. FluentBitでログルーティングの仕組みを構築する

## LogrageでJSON形式に構造化する

ログをJSON形式に変形するためにhttps://github.com/roidrage/logrageというライブラリを使用します。

```ruby
gem 'lograge'
```

まず、logrageをインストールします。

次にlogrageを有効化します。 `environments` 配下の環境ごとのファイルに記述しても良いのですが、

`initializers` 配下に `lograge.rb` を作成してそこにlogrageの設定を記述することにします。

```ruby
# frozen_string_literal: true

unless Rails.env.test? || Rails.env.development?
  Rails.application.configure do
    config.lograge.enabled = true

    config.lograge.custom_payload do |controller|
      request = controller.request
      current_user = controller.try(:current_user)
      log = {
        request_id: request.request_id,
        remote_ip:  request.remote_ip,
        host:       request.host,
        url:        request.original_url,
        user_agent: request.user_agent
      }
      log = log.merge(current_user: current_user) if current_user
      log
    end
    config.lograge.formatter = Lograge::Formatters::FluentBitJson.new
  end
end
```

`controller` メソッドにアクセスしてお馴染みの `current_user` や `request` オブジェクトを取得し

それらをログに含ませることが可能です。この部分は要件によって変わってくると思うので、ご自由に

カスタマイズしてください。ただし `user_agent` に関しては後述するヘルスチェックのログルーティングをするために必須となります。

📝メモ

`lograge.formatter` をLograge標準？のものにした時、ログがどうなるか確認。

これでリクエストのログはJSON形式に構造化されるのですが、 `Rails.logger` を使った場合に関しては残念ながら構造化されません。これを解消するためにformatterを自作します。