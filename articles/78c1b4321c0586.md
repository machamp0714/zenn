---
title: "RSpecå¿˜å‚™éŒ²"
emoji: "ğŸ‘‚"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['Rails', 'RSpec']
published: false
---
### Model Specã‚’æ›¸ã

ãƒ¢ãƒ‡ãƒ«ã®validationã‚„ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã¨æ€ã„ã¾ã™ãŒã€`shoulda-matchers` ãŒå¤§å¤‰ä¾¿åˆ©ã§ã—ãŸã€‚

```ruby
describe 'validations' do
  context 'when email is blank' do
    it do
      let(:user) { FactoryBot.build(email: nil) }

      user.valid?
      expect(user).to be_invalid
    end
  end
end
```

shoulda-matchersã‚’çŸ¥ã‚‹å‰ã¯validationã®ãƒ†ã‚¹ãƒˆã‚‚ã“ã‚“ãªæ„Ÿã˜ã§æ›¸ã„ã¦ã¾ã—ãŸãŒã€

`shoulda-matchers` ã‚’ä½¿ã†ã¨

```ruby
describe 'validations' do
	it do
		is_expected.to validate_presence_of(:email)
	end
end
```

validationã®ãƒ†ã‚¹ãƒˆã¯ã“ã®æ§˜ã«ã‚·ãƒ³ãƒ—ãƒ«ã«æ›¸ãã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚ä»–ã«ã‚‚

```ruby
describe 'validations' do
	it do
		is_expected.to validate_length_of(:password).is_at_least(8).is_at_most(128)
	end
end
```

ãªã©æ§˜ã€…ãªmatcherãŒã‚ã‚Šã¾ã™ã€‚

ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆã‚‚æ›¸ãã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚

```ruby
describe 'associations' do
	it do
		is_expected.to have_many(:posts).dependent(:destroy)
	end
end
```

### Requests Specã‚’æ›¸ã

requests specã«ã¯ã“ã¡ã‚‰ã®gemãŒå¤§å¤‰ä¾¿åˆ©ã§ã™ã€‚

```ruby
describe 'GET /posts' do
	it do
		get posts_path
		expect(response).to have_http_status(:ok)
	end
end
```

ã¨æ›¸ã„ã¦ã„ãŸãƒ†ã‚¹ãƒˆãŒ

```ruby
subject do
	send_request
	response
end

describe 'GET /posts' do
	it do
		is_expected.to have_http_status(:ok)
	end
end
```

ã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹å‡¦ç†ã‚’ç°¡æ½”ã«è¨˜è¿°å‡ºæ¥ã¾ã™ã€‚å€‹äººçš„ã«ã¯ã“ã®gemãŒRSpecå‘¨ã‚Šã®gemã®ä¸­ã§ä¸€ç•ªå¥½ãã§ã™ã€‚

```ruby
describe 'GET /posts' do
	it do
		subject
		expect(response).to have_http_status(:ok)
	end
end
```

ã¨æ›¸ãã“ã¨ã‚‚å‡ºæ¥ã‚‹ã®ã§ã™ãŒã€æ¯å› `subject` ã‚’æ›¸ãã®ã‚‚é¢å€’ãªã®ã§ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã«subjectã‚’å®šç¾©ã™ã‚‹

æ›¸ãæ–¹ãŒæ°—ã«å…¥ã£ã¦ã¾ã™ã€‚

### Policy Specã‚’æ›¸ã

ç§ã¯èªå¯ã®å®Ÿè£…ã«ã¯ `pundit` ã‚’åˆ©ç”¨ã—ã¦ãƒã‚·ãƒªãƒ¼å±¤ã‚’æ–°ã—ãè¿½åŠ ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€ãƒãƒªã‚·ãƒ¼å±¤ã®ãƒ†ã‚¹ãƒˆã«ã¯ `pundit-matchers` ã‚’ä½¿ã†ã®ãŒä¾¿åˆ©ã§ã—ãŸã€‚

ä¾‹ãˆã°æ¬¡ã®ã‚ˆã†ãªãƒãƒªã‚·ãƒ¼ã‚¯ãƒ©ã‚¹ãŒã‚ã‚‹ã¨ã—ã¾ã™ã€‚

```ruby
class PostsPolicy < AppricationPolicy
	def index?
		true
	end

	def create?
		user.admin?
	end

	def show?
		index?
	end

	def edit?
		create?
	end

	def update?
		create?
	end

	def destroy?
		create?
	end

	def permitted_attributes
		%i[title content]
	end
end
```

ã“ã®ãƒãƒªã‚·ãƒ¼ã‚¯ãƒ©ã‚¹ã®ãƒ†ã‚¹ãƒˆã¯æ¬¡ã®ã‚ˆã†ã«æ›¸ã‘ã¾ã™ã€‚

```ruby
RSpec.describe PostsPolicy, type: :policy do
	subject { described_class.new(user, model) }

	let(:model) { FactoryBot.build_stubbed(:post) }

	describe 'permissions' do
		context 'when user is admin' do
			let(:user) { FactoryBot.build_stubbed(:user, :admin) }
			it do
				is_expected.to permit_actions(%i[index create show edit update destroy])
			end
		end

		context 'when user is not admin' do
			let(:user) { FactoryBot.build_stubbed(:user) }
			it do
				is_expected.to permit_actions(%i[index show])
			end
		end
	end

	describe '#permitted_attributes' do
		it do
			is_expected.to permit_mass_assignment_of(%i[title content])
		end
	end
end
```

### ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ãƒ†ã‚¹ãƒˆã‚’æ›¸ã

ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ãƒ†ã‚¹ãƒˆã«ã¯ `fixture_file_upload` ãŒä½¿ãˆã¾ã™ã€‚

```ruby
RSpec.describe 'Posts', type: :request do
	subject do
		send_request
		response
	end

	describe 'POST /posts' do
		let(:params) do
			{
				posts: {
					title: 'hoge'
					content: 'piyo',
					file: file
				}
			}
		end
		let(:file) { fixture_file_upload('spec/fixtures/files/foo.png', 'image/png') }

		it do
			expect do
				subject
			end.to change(Post, :count).by(1)
		end
	end
end
```

### ActiveJobã‚’åŒæœŸå®Ÿè¡Œã—ãŸã„å ´åˆ

`deliver_later` ã§ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¦ã„ã¦ãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚ŒãŸã“ã¨ã‚’ãƒ†ã‚¹ãƒˆã—ãŸã„å ´åˆã€

ãƒ†ã‚¹ãƒˆã®æ™‚ã¯ã‚¸ãƒ§ãƒ–ã‚’åŒæœŸå®Ÿè¡Œã—ãŸã„ã§ã™ã€‚ãã‚“ãªæ™‚ã«ã¯ `perform_enqueued_jobs` ãŒä½¿ãˆã¾ã™ã€‚

```ruby
RSpec.describe 'Registrations', type: :request do
	subject do
		send_request
		response
	end

	describe 'POST /sign_up' do
		before do
			UserMailer.deliveries.clear
		end

		it do
			expect do
				perform_enqueued_jobs { send_request } # ã“ã®ä¸­ã§deliver_laterãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹
			end.to change { UserMailer.deliveries.size }.by(1)
		end
	end
end
```

`perform_enqueued_jobs` ã¯ãƒ–ãƒ­ãƒƒã‚¯å†…ã®ActiveJobã‚’åŒæœŸå®Ÿè¡Œã—ã¦ãã‚Œã¾ã™ã€‚
