---
title: "Sidekiq ã‚’ Capistrano ã§ãƒ‡ãƒ—ãƒ­ã‚¤"
emoji: "ğŸ“Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Rails"]
published: true
---
Sidekiq ã‚’ EC2 ã§ä½œã£ãŸæœ¬ç•ªç’°å¢ƒä¸Šã§ç¨¼åƒã•ã›ã‚‹ãŸã‚ã« systemd ã§ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸã®ã§ã€
ãã®æ–¹æ³•ã¨ã€Capistrano ã§å†èµ·å‹•ã•ã›ã‚‹æ–¹æ³•ã‚’å¿˜å‚™éŒ²ã¨ã—ã¦ã¾ã¨ã‚ã¾ã—ãŸğŸ™Œ

## å‰æ

- ruby 2.6.3
- Rails 6.0.3
- Sidekiq 6.4.1
- Capistrano 3.14.1

## ç›®æ¬¡

1. systemd ã§ Sidekiq ã‚’ç®¡ç†ã™ã‚‹
2. `sudo` ã‚’ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã—ã§å®Ÿè¡Œå‡ºæ¥ã‚‹ã‚ˆã†ã«ã™ã‚‹
3. Capistrano ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
4. Capfile ã‚’ä¿®æ­£

## systemd ã§ Sidekiq ã‚’ç®¡ç†ã™ã‚‹

Sidekiq6 ä»¥é™ãƒ‡ãƒ¼ãƒ¢ãƒ³ã¨ã—ã¦å‹•ä½œã™ã‚‹ã®ã§ã¯ãªãã€ `systemd` ãªã©ã§ç®¡ç†ã™ã‚‹æ–¹é‡ã«å¤‰æ›´ã•ã‚ŒãŸ
ã®ã§ã€ã¾ãš `systemd` ã§ç®¡ç†ã™ã‚‹ãŸã‚ Unit ã‚’å®šç¾©ã—ã¾ã™ã€‚Unit ã®å†…å®¹ã«é–¢ã—ã¦ã¯ [ã“ã¡ã‚‰](https://github.com/mperham/sidekiq/blob/main/examples/systemd/sidekiq.service) ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚

```
# /etc/systemd/system/sidekiq.service

[Unit]
Description=sidekiq
After=syslog.target network.target

[Service]
Type=notify

WatchdogSec=10

WorkingDirectory=/var/www/example/staging/current

ExecStart=/bin/bash -lc 'exec /home/deploy/.rbenv/shims/bundle exec sidekiq -e staging -C config/sidekiq.yml'
ExecReload=/bin/kill -TSTP $MAINPID

Environment=MALLOC_ARENA_MAX=2

RestartSec=1
Restart=always

[Install]
WantedBy=multi-user.target
```

ã“ã®è¨˜äº‹ã§ã¯ã“ã® Unit ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã¿ç°¡å˜ã«è§£èª¬ã—ã¾ã™ã€‚
Unit ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ŒUnitã€ã€ŒServiceã€ã€ŒInstallã€ã¨ã„ã†ï¼“ã¤ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§æ§‹æˆã•ã‚Œã€å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å½¹å‰²ã¯ä»¥ä¸‹ã®æ§˜ã«ãªã‚Šã¾ã™ã€‚
| ã‚»ã‚¯ã‚·ãƒ§ãƒ³ | èª¬æ˜ |
| --- | --- |
| Unit | Unit ã®èª¬æ˜ãƒ»ä¾å­˜é–¢ä¿‚ã‚’è¨˜è¿°ã™ã‚‹ |
| Service | å›ºæœ‰ã®è¨­å®šé …ç›® |
| Install | systemctl enable/disable ã®å‹•ä½œã«å½±éŸ¿ã™ã‚‹è¨­å®šé …ç›® |

æ¬¡ã«ä¸Šè¨˜ã® Unit ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦ã¾ã¨ã‚ã¦ã„ãã¾ã™ã€‚

**Unit**
| ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | èª¬æ˜ |
| --- | --- |
| Description | Unit ã®èª¬æ˜ |
| After | ã“ã® Unit ã‚ˆã‚Šå…ˆã«èµ·å‹•ã™ã‚‹ Unit |

**Service**
| ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | èª¬æ˜ |
| --- | --- |
| Type | ã“ã® Unit ã®ãƒ—ãƒ­ã‚»ã‚¹èµ·å‹•ã‚¿ã‚¤ãƒ—ã‚’è¨­å®šã™ã‚‹ã€‚ `notify` ã¯ `exec` (`fork()â†’execve()` ã§æ–°ã—ã„ãƒ—ãƒ­ã‚»ã‚¹ãŒå®Ÿè¡Œã•ã‚Œã‚‹)ã¨ä¼¼ã¦ã„ã¾ã™ãŒã€ `sd_notify(3)` ã‚’ä»‹ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€šã•ã‚Œã‚‹ã“ã¨ãŒæœŸå¾…ã•ã‚Œã‚‹|
| WatchdogSec | WatchDog ã¯ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®šæœŸçš„ã«ç›£è¦–ã—ã¦ç¨¼åƒçŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã‚Œã‚‹æ©Ÿèƒ½ã€‚ WatchdogSec ã§æŒ‡å®šã—ãŸæ™‚é–“å†…ã«å¿œç­”ãŒãªã‘ã‚Œã° WatchdogSignal ã§æŒ‡å®šã—ãŸ Signal ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ã™ã‚‹ |
| WorkingDirectory | ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®š |
| ExecStart | ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã® `start` æ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒãƒ³ãƒ‰ |
| ExecReload | ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã® `reload` æ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒãƒ³ãƒ‰ |
| Environment | ç’°å¢ƒå¤‰æ•°ã‚’å®šç¾©ã™ã‚‹ã€‚ä»Šå›ã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã‚ãŸã‚Šã®ãƒ¡ãƒ¢ãƒªã‚¢ãƒªãƒ¼ãƒŠã‚’åˆ¶é™ã™ã‚‹ãŸã‚ `MALLOC_ARENA_MAX` ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚ï¼ˆ[ã“ã¡ã‚‰](https://techracho.bpsinc.jp/hachi8833/2017_12_28/50109) ã®è¨˜äº‹  ã‚‚åˆã‚ã›ã¦èª­ã‚€ã®ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ï¼‰ |
| RestartSec | ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•ã™ã‚‹å‰ã«ã‚¹ãƒªãƒ¼ãƒ—ã™ã‚‹æ™‚é–“ã‚’æŒ‡å®šã™ã‚‹ |
| Restart | ãƒ—ãƒ­ã‚»ã‚¹ãŒçµ‚äº†ã€å¼·åˆ¶çµ‚äº†ã€ã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸæ™‚ã«å†èµ·å‹•ã™ã‚‹ã‹ã©ã†ã‹æŒ‡å®šã™ã‚‹ã€‚`no` `on-success` `on-failure` `on-abnormal` `on-watchdog` `on-abort` `always` ãŒæŒ‡å®šå‡ºæ¥ã‚‹ã€‚`no` ã®æ™‚ã¯å†èµ·å‹•ã—ãªã„|

[ã“ã¡ã‚‰](https://github.com/mperham/sidekiq/blob/main/examples/systemd/sidekiq.service) ã«ã¯ `ExecReload` ã®æŒ‡å®šã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ `capistrano-sidekiq` ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹éš›ã€ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æŒ‡å®šãŒãªã„ã¨

```
00:02 sidekiq:quiet
01 sudo systemctl reload sidekiq.service
01 Failed to reload sidekiq.service: Job type reload is not applicable for unit sidekiq.service.
01 See system logs and 'systemctl status sidekiq.service' for details.
âœ˜ 01 hoge@i-05413653a3f710cc8 0.077s
```

ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸãŸã‚æŒ‡å®šã—ã¾ã—ãŸã€‚ãƒ—ãƒ­ã‚»ã‚¹ã® PID ã¯ç’°å¢ƒå¤‰æ•°  `$MAINPID` ã§å‚ç…§ã§ãã€
`TSTP` ã‚·ã‚°ãƒŠãƒ«ã¯ä¸€æ™‚åœæ­¢ã‚’æ„å‘³ã—ã¾ã™ã€‚

**Install**
| ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | èª¬æ˜ |
| --- | --- |
| WantedBy | `enable` æ™‚ã«ã“ã®Unitã® `.wants` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ä½œæˆã™ã‚‹ã€‚ä»Šå›ã®å ´åˆ `multi-user.target.wants` å†…ã«ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ãŒä½œæˆã•ã‚Œã‚‹ |

ä»¥ä¸ŠãŒ `Sidekiq` ã® `Unit` ã®è§£èª¬ã¨ãªã‚Šã¾ã™ãŒã€ã•ã‚‰ã« `Systemd` ã«ã¤ã„ã¦å­¦ã³ãŸã„æ–¹ã«ã¯ [ã“ã¡ã‚‰](https://enakai00.hatenablog.com/entry/20130914/1379146157) ã®è¨˜äº‹ãŒå‚è€ƒã«ãªã‚‹ã‹ã¨æ€ã†ã®ã§ã”ä¸€èª­ãã ã•ã„ã€‚

## `sudo` ã‚’ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã—ã§å®Ÿè¡Œå‡ºæ¥ã‚‹ã‚ˆã†ã«ã™ã‚‹

`capistrano-sidekiq` ã‚’ä½¿ã£ã¦ Sidekiq ã‚’å†èµ·å‹•ã™ã‚‹éš›ã€ `systemctl` ã‚’ `sudo` ã§å®Ÿè¡Œã—ã¾ã™
ãŒã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¦æ±‚ã•ã‚Œã¦ã—ã¾ã†ã®ã§ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã—ã§å®Ÿè¡Œå‡ºæ¥ã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ã¦è¡Œãã¾ã™ã€‚

```bash
$ sudo visudo
```

ã§ `visudo` ã‚’é–‹ãã¾ã™ã€‚

```bash
## Allow root to run any commands anywhere
root    ALL=(ALL:ALL)       ALL
```

ã“ã¡ã‚‰ã®éƒ¨åˆ†ã®ä¸‹ã®è¡Œã«æ–°ã—ã„æ¨©é™ã‚’è¿½åŠ ã—ã¦ã„ãã¾ã™ãŒã€ãã®å‰ã«ã“ã® `ALL` ãŒä½•ã‚’æ„å‘³ã—ã¦ã„ã‚‹ã®ã‹ã¾ã¨ã‚ã¦ãŠãã¾ã™ã€‚

| # | èª¬æ˜ |
| --- | --- |
| =ã®å·¦å´ã®ALL | è¨±å¯ã™ã‚‹ãƒ›ã‚¹ãƒˆ |
| ()ã®ä¸­ã®å·¦å´ã®ALL | ã“ã“ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’æŒ‡å®šã™ã‚‹ã¨ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨åŒã˜æ¨©é™ã‚’å¾—ã‚‰ã‚Œã‚‹ã€‚ALLã‚’æŒ‡å®šã™ã‚‹ã¨ã©ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚‚ãªã‚Œã‚‹ |
| ()ã®ä¸­ã®å³å´ã®ALL | ä¸Šè¨˜ã®ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ¼ã‚¸ãƒ§ãƒ³ |
| æœ€å¾Œã®ALL | å®Ÿè¡Œå‡ºæ¥ã‚‹ã‚³ãƒãƒ³ãƒ‰ã€‚ã‚³ãƒãƒ³ãƒ‰ã‚’è¤‡æ•°æŒ‡å®šã—ãŸã„æ™‚ã¯ã€`,` ã§åŒºåˆ‡ã‚‹

ä»Šå›ã®å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒ `hoge` ã ã¨ã—ã¦ã€ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã—ã§ `/usr/bin/systemctl` ã®ã¿å®Ÿè¡Œå‡ºæ¥ã‚‹ã€ã¨ã„ã†æ¨©é™ã«ã—ãŸã„ã®ã§ä»¥ä¸‹ã®æ§˜ã«ãªã‚Šã¾ã™ã€‚

```bash
hoge  ALL=(ALL) NOPASSWD: /usr/bin/systemctl
```

## Capfile ã‚’ä¿®æ­£

æ—¢ã« `capistrano` ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹å‰æã¨ã—ã¦ã€ `capistrano-sidekiq` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```ruby
# Gemfile

group 'development' do
  gem 'capistrano-sidekiq'
end
```

ã•ã‚‰ã« `Capfile` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```ruby
# Capfile

require 'capistrano/sidekiq'
install_plugin Capistrano::Sidekiq
install_plugin Capistrano::Sidekiq::Systemd
```

`capistrano-sidekiq` ã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§ã¿ã‚‹ã¨ã€æ¬¡ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ `systemctl` ã‚³ãƒãƒ³ãƒ‰ã‚’çµ„ã¿ç«‹ã¦ã¦ã„ã‚‹ã®ã§ã™ãŒã€ `sidekiq_service_unit_user` ã« `:system` ã‚’è¨­å®šã—ãªã„å ´åˆã€ `systemctl --user` ã‚’å®Ÿè¡Œã—ã¦ã—ã¾ã„ã¾ã™ã€‚

```ruby
def systemctl_command(*args, process: nil)
  execute_array =
    if fetch(:sidekiq_service_unit_user) == :system
      [:sudo, :systemctl]
    else
      [:systemctl, '--user']
    end

  if process
    execute_array.push(
      *args, sidekiq_service_unit_name(process: process)
    ).flatten
    backend.execute(*execute_array, raise_on_non_zero_exit: false)
  else
    execute_array.push(*args, sidekiq_service_unit_name).flatten
    backend.execute(*execute_array, raise_on_non_zero_exit: false)
  end
end
```

ä»Šå›ã¯ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ã—ãŸã„ã®ã§ã€ `sidekiq_service_unit_user` ã« `:system` ã‚’æŒ‡å®šã—ã¦ `sudo` ã§ `systemctl` ã‚’å®Ÿè¡Œå‡ºæ¥ã‚‹ã‚ˆã†ã« `config/deploy.rb` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```ruby
# config/deploy.rb

set :sidekiq_service_unit_user, :system
```

ã“ã“ã¾ã§å®Œäº†ã™ã‚Œã°æ¬¡ã®ã‚¿ã‚¹ã‚¯ãŒå®Ÿè¡Œå‡ºæ¥ã‚‹ã¯ãšã§ã™ã€‚

```
bundle exec cap production sidekiq:stop
bundle exec cap production sidekiq:start
bundle exec cap production sidekiq:quiet
bundle exec cap production sidekiq:restart
```

## å‚è€ƒè³‡æ–™

https://github.com/mperham/sidekiq/blob/main/examples/systemd/sidekiq.service
https://qiita.com/JhonnyBravo/items/a28074c20fa9adf02be3#execreload
https://enakai00.hatenablog.com/entry/20130914/1379146157